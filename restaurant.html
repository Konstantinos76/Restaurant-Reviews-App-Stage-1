<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#333"/>
  <!-- Normalize.css for better cross-browser consistency -->
  <link rel="stylesheet" src="//normalize-css.googlecode.com/svn/trunk/normalize.css" />
  <!-- Main CSS file -->
  <link rel="stylesheet" href="css/styles.css" type="text/css">
  <link rel="manifest" href="/manifest.json">
  <title>Restaurant Info</title>
  <style>
    /* Overrides global 'hidden map' rule. 
    The map is open by default in inner page. */
    #map {
      display: block !important;
    }
  </style>
</head>

<body class="inside">
  <!-- Beginning header -->
  <header>
    <!-- Beginning nav -->
    <nav>
      <h1><a href="/">Restaurant Reviews</a></h1>
    </nav>
    <!-- Beginning breadcrumb -->

    <!-- Accessibility - Breadcrum -->
    <div role="navigation" aria-label="Breadcrumb">
      <ul id="breadcrumb" >
        <li><a href="/">Home</a></li>
      </ul>
    </div>
     <!-- End of Accessibility - Breadcrum -->

    <!-- End breadcrumb -->
    <!-- End nav -->
  </header>
  <!-- End header -->

  <!-- Beginning main -->
  <!-- <main id="maincontent">
    <!-- Beginning map -->
    <section id="map-container">

      <!-- Accessibility - Google map section  -->
      <!-- This has also an aria-label attribute set in restaurant_info.js -->
      <div id="map" role="application"></div>
       <!-- End of Accessibility - Google map section  -->

    </section>
    <!-- End map -->
    <!-- Beginning restaurant -->
    <section id="restaurant-container">
      <h2 id="restaurant-name"></h2>
      <img id="restaurant-img">
      <p id="restaurant-cuisine"></p>
      <p id="restaurant-address"></p>
      <table id="restaurant-hours"></table>
    </section>
    <!-- end restaurant -->
    <!-- Beginning reviews -->
    <section id="reviews-container">
      
      <!-- Beginning form to add review -->
      <h3 aria-label="Add your review for this restaurant.">Add your review</h3>
      <form id="addReviewForm">
        <p>Your name:</p> 
        <input type="text" id='add-review-name-field' placeholder="Your name">
        <br>
        <p>Your rating:</p>
        <select id="add-review-select-field">
          <option selected="selected" disabled="disabled">All Star</option>
          <option value="1">1 Star rating</option>
          <option value="2">2 Star rating</option>
          <option value="3">3 Star rating</option>
          <option value="4">4 Star rating</option>
          <option value="5">5 Star rating</option>
        </select>
        <br>
        <p>Your comments:</p>
        <textarea id="add-review-textfield" rows="4" cols="50" placeholder="Your comments"></textarea>
        <br>
        <input type="submit" value="Submit">
      </form>
      <!-- End of form to add review -->
      
      <ul id="reviews-list"></ul>

    </section>
    <!-- End reviews -->
  </main>
  <!-- End main -->

  <!-- Beginning footer -->
  <footer id="footer">
      Copyright (c) 2017 <a href="/"><strong>Restaurant Reviews</strong></a> <br>All Rights Reserved.
  </footer>
  <!-- End footer -->

  <!-- Beginning scripts -->
  <!-- idb Library  -->
  <script type="application/javascript" charset="utf-8" src="js/idb.js"></script>
   <!-- End of idb Library  -->
  <script type="application/javascript" charset="utf-8" src="js/index.js"></script>
  <!-- Database helpers -->
  <script type="text/javascript" src="js/dbhelper.js"></script>
  <!-- Main javascript file -->
  <script type="text/javascript" src="js/restaurant_info.js"></script>
  <!-- Google Maps -->
  <!-- <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_tKbW6A5pQ-eupxI56myUnHLqYCzOjKo&libraries=places&callback=initMap"></script> -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCxAII9f0khW4_p2_hNF9pp3nUcNiZW0fg&libraries=places&callback=initMap"></script>
  <!-- End scripts -->
  <script>
    const url = window.location.href;
    const urlStringLength = window.location.href.length;
    const restaurantId = url.charAt(urlStringLength-1);

    function fetchReviews() {
      let htmlContent = '';
      const reviewsul = document.querySelector('#reviews-list');

      fetch(`http://localhost:1337/reviews/?restaurant_id=${restaurantId}`)
        .then(response => response.json())
        .then(showReviews)
        .catch(err => requestError(err));

      function showReviews(data) {
        if(data && data.length > 1) {
          const reviews = data;
          htmlContent = reviews.map(review => `<li>
          <p>${review.name}</p>
          <p>${review.createdAt}</p>
          <p>Rating: ${review.rating}</p>
          <p>${review.comments}</p>
          </li>`).join('');
        } else {
        htmlContent = '<div>No reviews for this restaurant</div>';
        }
      reviewsul.insertAdjacentHTML('beforeend', htmlContent);
      }

      function requestError(err) {
        console.log(err);
        reviewsul.insertAdjacentHTML('beforeend', '<div>Network: Error fetching reviews.');
      }
    }

    fetchReviews();
    
    document.getElementById("addReviewForm").addEventListener("submit", function() {
      let name = document.getElementById('add-review-name-field').value;
      let rating = document.getElementById('add-review-select-field').value;
      let comments = document.getElementById('add-review-textfield').value;
    
      let data = {
        "restaurant_id": restaurantId,
        "name": name,
        "rating": rating,
        "comments": comments
      };
      fetch('http://localhost:1337/reviews/', {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
          'Content-Type': 'application/json'
        }
      }).then(res => res.json())
        .then(function() {
          window.location.href = url;
        })
    });
  </script>
</body>

</html>
